---
title: "Data preparation"
bibliography: references.bib
link-citations: true
date: "Last compiled on `r format(Sys.time(), '%B, %Y')`"
output: 
  html_document:
    css: tweaks.css
    toc:  true
    toc_float: true
    number_sections: true
    toc_depth: 2
    code_folding: show
    code_download: yes
---


```{r, globalsettings, echo=FALSE, warning=FALSE, results='hide', message=FALSE}
library(knitr)
library(tidyverse) 
knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, class.source=c("test"), class.output=c("test3"))
options(width = 100)
rgl::setupKnitr()

colorize <- function(x, color) {sprintf("<span style='color: %s;'>%s</span>", color, x) }
```


```{r klippy, echo=FALSE, include=TRUE}
#install.packages("remotes")
#remotes::install_github("rlesur/klippy")
klippy::klippy(position = c('top', 'right'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```


---  

The following scripts can be used to replicate the data-set of @Franken2023. It may also be obtained by downloading: `r xfun::embed_file("./data shared/netbehdata.RDa")`



----

<br>

# Getting started

To copy the code, click the button in the upper right corner of the code-chunks.

## clean up

```{r clean, results='hide'}
rm(list=ls())
gc()
```

<br>

## general custom functions

- `fpackage.check`: Check if packages are installed (and install if not) in R
- `fsave`: Function to save data with time stamp in correct directory
- `fload`: Load R-objects under new names
- `fshowdf`: Print objects (`tibble` / `data.frame`) nicely on screen in `.Rmd`.

```{r custom_packages, eval=FALSE}
fpackage.check <- function(packages) {
    lapply(packages, FUN = function(x) {
        if (!require(x, character.only = TRUE)) {
            install.packages(x, dependencies = TRUE)
            library(x, character.only = TRUE)
        }
    })
}

fsave <- function(x, file, location = "./data/processed/", ...) {
    if (!dir.exists(location))
        dir.create(location)
    datename <- substr(gsub("[:-]", "", Sys.time()), 1, 8)
    totalname <- paste(location, datename, file, sep = "")
    print(paste("SAVED: ", totalname, sep = ""))
    save(x, file = totalname)
}

fload  <- function(fileName){
  load(fileName)
  get(ls()[ls() != "fileName"])
}

fshowdf <- function(x, digits = 2, ...) {
    knitr::kable(x, digits = digits, "html", ...) %>%
        kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
        kableExtra::scroll_box(width = "100%", height = "300px")
}
```

<br>

## necessary packages

- `dplyr`: package for data wrangling
- `lubridate`: parse and manipulate dates
- `stringr`: string manipulation

```{r packages, eval=FALSE}
packages = c("dplyr", "lubridate", "stringr")
fpackage.check(packages)
rm(list = setdiff(ls(), lsf.str()))
```
<br>

# Download data

Anonymized data-sets of the 'Sports and Friendships' study are deposited in DANS Data Station SSH [@data2022]. For this study we use waves 3 (i.e., wave 1 of cohort II)

- `r xfun::embed_file("./data/wave3_public.RDa")`

Download the data-file, and put it in the `./data/` folder. But first, make a `./data/` folder: 

```{r download, eval=FALSE}
ifelse(!dir.exists("data"), dir.create("data"), FALSE)
``` 

<br>

To see the code used to anonymize the raw data files, see: https://netchange.netlify.app/prep.


# Import data

Load the downloaded data. First, we clean our environment (but we keep our functions; we need them later on).

```{r, import, eval=FALSE}
#load public data
data3 <- fload("./data/wave3_public.RDa")
```


<br>

----

# Network data

The 'fitness network' (i.e., consisting of sports network members whom ego primarily does fitness with.)

## Select fitness respondents

I select respondents who engaged in fitness:

- those who indicated participation in fitness during wave 1.

```{r, select_respondent, eval=FALSE}
#get respnr of respondents who reported to have done fitness at w1
ids <- data3$respnr[which(data3$S1a.SQ001. == "Ja")]
length(ids)/nrow(data3) #amounting to 63% of w1-respondents

#subset data of these respondents
data <- data3[which(data3$respnr %in% ids),]
```

<br>

---

## Fitness network

Dataframe, with alters nested in ego. Wave 1

```{r, fitness_network, eval=FALSE}
# make a dataframe of w1-alters, with potential duplicates...
# recall that all alter names were replaced with a unique anonymized alter-id
df_names <- data.frame(
  p1 = data$egonet1.SQ001.,
  p2 = data$egonet1.SQ002.,
  p3 = data$egonet1.SQ003.,
  p4 = data$egonet1.SQ004.,
  p5 = data$egonet1.SQ005.,
  p6 = data$egonet2.SQ001.,
  p7 = data$egonet2.SQ002.,
  p8 = data$egonet2.SQ003.,
  p9 = data$egonet2.SQ004.,
  p10= data$egonet2.SQ005.,
  p11= data$egonet3.SQ001.,
  p12= data$egonet3.SQ002.,
  p13= data$egonet3.SQ003.,
  p14= data$egonet3.SQ004.,
  p15= data$egonet3.SQ005.,
  p16= data$egonet4.SQ001.,
  p17= data$egonet4.SQ002.,
  p18= data$egonet4.SQ003.,
  p19= data$egonet4.SQ004.,
  p20= data$egonet4.SQ005.)

#"pre-allocate" empty list of length equals number of egos
alterL <- vector("list", nrow(df_names))

# loop over all egos
for ( i in 1:length(alterL)) {
    alterL[[i]] <- data.frame(
      ego_gender = NA, ego_age = NA, ego_educ = NA,
      alterid = 1:20, name1 = NA, name2 = NA, name3 = NA, name4 = NA,
      alter_gender = NA, alter_age = NA, alter_educ=NA,
      same_gender = NA, dif_age = NA, sim_educ = NA)
}

# fill the names based on the names data-frame and replace empty strings with <NA>
for ( i in 1:length(alterL)) {
  alterL[[i]]$name1 <- unlist(df_names[i, ], use.names=FALSE)
  alterL[[i]]$name1 <- ifelse(alterL[[i]]$name1=="", NA, alterL[[i]]$name1)
}

# a matching matrix allowed ego to match names that referred to the same person.
# in limesurvey, i could not let the number of columns condition
# on the number of alters named in the latest egonet, so i made 5 separate matrices,
# conditional on netsize.
# i calculate netsize for each net
{
  net1 <- cbind(data$egonet1.SQ001.,data$egonet1.SQ002., data$egonet1.SQ003.,data$egonet1.SQ004., data$egonet1.SQ005.)
  net1 <- ifelse(net1=="", NA, net1)
  ns1 <- vector()
  for (i in 1:nrow(net1)) {
    ns1[i] <- length(net1[i,][which(!is.na(net1[i,]))])
  }
  net2 <- cbind(data$egonet2.SQ001.,data$egonet2.SQ002., data$egonet2.SQ003.,data$egonet2.SQ004., data$egonet2.SQ005.)
  net2 <- ifelse(net2=="", NA, net2)
  ns2 <- vector()
  for (i in 1:nrow(net2)) {
    ns2[i] <- length(net2[i,][which(!is.na(net2[i,]))])
  }
  net3 <- cbind(data$egonet3.SQ001.,data$egonet3.SQ002., data$egonet3.SQ003.,data$egonet3.SQ004., data$egonet3.SQ005.)
  net3 <- ifelse(net3=="", NA, net3)
  ns3 <- vector()
  for (i in 1:nrow(net3)) {
    ns3[i] <- length(net3[i,][which(!is.na(net3[i,]))])
  }
  net4 <- cbind(data$egonet4.SQ001.,data$egonet4.SQ002., data$egonet4.SQ003.,data$egonet4.SQ004., data$egonet4.SQ005.)
  net4 <- ifelse(net4=="", NA, net4)
  ns4 <- vector()
  for (i in 1:nrow(net4)) {
    ns4[i] <- length(net4[i,][which(!is.na(net4[i,]))])
  }
}

# i construct the matching matrices, 1 - 5 (conditional on the ns of the latest net)
# put these in a list and list these again, for each respondent (so a list of lists...)
matchingList <- list()
for (i in 1:length(alterL)) { # for ego i
  matchingL <- list()
  # make 5 seperate matching matrices. naturally, only 1 is relevant... but i will select that later.
  matchingL[[1]] <- cbind(data$matching1N1.SQ001_SQ001.[i],data$matching1N1.SQ002_SQ001.[i],data$matching1N1.SQ003_SQ001.[i],data$matching1N1.SQ004_SQ001.[i],data$matching1N1.SQ005_SQ001.[i])
  matchingL[[2]]<- rbind(
    cbind(data$matching1N2.SQ001_SQ001.[i], data$matching1N2.SQ002_SQ001.[i], data$matching1N2.SQ003_SQ001.[i], data$matching1N2.SQ004_SQ001.[i], data$matching1N2.SQ005_SQ001.[i]),
    cbind(data$matching1N2.SQ001_SQ002.[i], data$matching1N2.SQ002_SQ002.[i], data$matching1N2.SQ003_SQ002.[i], data$matching1N2.SQ004_SQ002.[i], data$matching1N2.SQ005_SQ002.[i]))
  matchingL[[3]]<- rbind(
    cbind(data$matching1N3.SQ001_SQ001.[i], data$matching1N3.SQ002_SQ001.[i], data$matching1N3.SQ003_SQ001.[i], data$matching1N3.SQ004_SQ001.[i], data$matching1N3.SQ005_SQ001.[i]),
    cbind(data$matching1N3.SQ001_SQ002.[i], data$matching1N3.SQ002_SQ002.[i], data$matching1N3.SQ003_SQ002.[i], data$matching1N3.SQ004_SQ002.[i], data$matching1N3.SQ005_SQ002.[i]),
    cbind(data$matching1N3.SQ001_SQ003.[i], data$matching1N3.SQ002_SQ003.[i], data$matching1N3.SQ003_SQ003.[i], data$matching1N3.SQ004_SQ003.[i], data$matching1N3.SQ005_SQ003.[i]))
  matchingL[[4]]<- rbind(
    cbind(data$matching1N4.SQ001_SQ001.[i], data$matching1N4.SQ002_SQ001.[i], data$matching1N4.SQ003_SQ001.[i], data$matching1N4.SQ004_SQ001.[i], data$matching1N4.SQ005_SQ001.[i]),
    cbind(data$matching1N4.SQ001_SQ002.[i], data$matching1N4.SQ002_SQ002.[i], data$matching1N4.SQ003_SQ002.[i], data$matching1N4.SQ004_SQ002.[i], data$matching1N4.SQ005_SQ002.[i]),
    cbind(data$matching1N4.SQ001_SQ003.[i], data$matching1N4.SQ002_SQ003.[i], data$matching1N4.SQ003_SQ003.[i], data$matching1N4.SQ004_SQ003.[i], data$matching1N4.SQ005_SQ003.[i]),
    cbind(data$matching1N4.SQ001_SQ004.[i], data$matching1N4.SQ002_SQ004.[i], data$matching1N4.SQ003_SQ004.[i], data$matching1N4.SQ004_SQ004.[i], data$matching1N4.SQ005_SQ004.[i]))
  matchingL[[5]]<- rbind(
    cbind(data$matching1N5.SQ001_SQ001.[i], data$matching1N5.SQ002_SQ001.[i], data$matching1N5.SQ003_SQ001.[i], data$matching1N5.SQ004_SQ001.[i], data$matching1N5.SQ005_SQ001.[i]),
    cbind(data$matching1N5.SQ001_SQ002.[i], data$matching1N5.SQ002_SQ002.[i], data$matching1N5.SQ003_SQ002.[i], data$matching1N5.SQ004_SQ002.[i], data$matching1N5.SQ005_SQ002.[i]),
    cbind(data$matching1N5.SQ001_SQ003.[i], data$matching1N5.SQ002_SQ003.[i], data$matching1N5.SQ003_SQ003.[i], data$matching1N5.SQ004_SQ003.[i], data$matching1N5.SQ005_SQ003.[i]),
    cbind(data$matching1N5.SQ001_SQ004.[i], data$matching1N5.SQ002_SQ004.[i], data$matching1N5.SQ003_SQ004.[i], data$matching1N5.SQ004_SQ004.[i], data$matching1N5.SQ005_SQ004.[i]),
    cbind(data$matching1N5.SQ001_SQ005.[i], data$matching1N5.SQ002_SQ005.[i], data$matching1N5.SQ003_SQ005.[i], data$matching1N5.SQ004_SQ005.[i], data$matching1N5.SQ005_SQ005.[i]))
  matchingList[[i]] <- matchingL
} # so... matchingL[[1]][[5]] is matchingmatrix 5 (i.e., 5 alters named in egonet2) for ego 1

# the combination of the matching matrices and the netsizes for ego allows me to match the names myself.
for (i in 1:length(matchingList)) {     # for ego i
  mL <- matchingList[[i]]               # get the matching list
  ns <- ns2[[i]]                        # get the size of egonet2
  if(ns>0) {                            # if ns=0, no matching was done!
    mm <- as.matrix(mL[[ns]])           # retrieve the corresponding matrix
    matched <- which(mm==1, arr.ind=T)  # retrieve array indices
    net <- net2[i,]
    if(length(matched)>0) {             # if matching was performed!
      alterL[[i]]$name2[which(alterL[[i]]$alterid==matched[,2])] <- net[matched[,1]]
    }
  }
} #ignore warning

#repeat for the second matching matrices
# (i.e., matching egonet3 alters to prev. alters);
matchingList2 <- list()
for (i in 1:length(alterL)) { # for ego i
  matching2L <- list()
  matching2L[[1]] <- cbind(data$matching2N1.SQ001_SQ001.[i],data$matching2N1.SQ002_SQ001.[i],data$matching2N1.SQ003_SQ001.[i],data$matching2N1.SQ004_SQ001.[i],data$matching2N1.SQ005_SQ001.[i],data$matching2N1.SQ006_SQ001.[i],data$matching2N1.SQ007_SQ001.[i],data$matching2N1.SQ008_SQ001.[i],data$matching2N1.SQ009_SQ001.[i],data$matching2N1.SQ010_SQ001.[i])
  matching2L[[2]] <- rbind(
    cbind(data$matching2N2.SQ001_SQ001.[i],data$matching2N2.SQ002_SQ001.[i],data$matching2N2.SQ003_SQ001.[i],data$matching2N2.SQ004_SQ001.[i],data$matching2N2.SQ005_SQ001.[i],data$matching2N2.SQ006_SQ001.[i],data$matching2N2.SQ007_SQ001.[i],data$matching2N2.SQ008_SQ001.[i],data$matching2N2.SQ009_SQ001.[i],data$matching2N2.SQ010_SQ001.[i]),
    cbind(data$matching2N2.SQ001_SQ002.[i],data$matching2N2.SQ002_SQ002.[i],data$matching2N2.SQ003_SQ002.[i],data$matching2N2.SQ004_SQ002.[i],data$matching2N2.SQ005_SQ002.[i],data$matching2N2.SQ006_SQ002.[i],data$matching2N2.SQ007_SQ002.[i],data$matching2N2.SQ008_SQ002.[i],data$matching2N2.SQ009_SQ002.[i],data$matching2N2.SQ010_SQ002.[i]))
  matching2L[[3]] <- rbind(
    cbind(data$matching2N3.SQ001_SQ001.[i],data$matching2N3.SQ002_SQ001.[i],data$matching2N3.SQ003_SQ001.[i],data$matching2N3.SQ004_SQ001.[i],data$matching2N3.SQ005_SQ001.[i],data$matching2N3.SQ006_SQ001.[i],data$matching2N3.SQ007_SQ001.[i],data$matching2N3.SQ008_SQ001.[i],data$matching2N3.SQ009_SQ001.[i],data$matching2N3.SQ010_SQ001.[i]),
    cbind(data$matching2N3.SQ001_SQ002.[i],data$matching2N3.SQ002_SQ002.[i],data$matching2N3.SQ003_SQ002.[i],data$matching2N3.SQ004_SQ002.[i],data$matching2N3.SQ005_SQ002.[i],data$matching2N3.SQ006_SQ002.[i],data$matching2N3.SQ007_SQ002.[i],data$matching2N3.SQ008_SQ002.[i],data$matching2N3.SQ009_SQ002.[i],data$matching2N3.SQ010_SQ002.[i]),
    cbind(data$matching2N3.SQ001_SQ003.[i],data$matching2N3.SQ002_SQ003.[i],data$matching2N3.SQ003_SQ003.[i],data$matching2N3.SQ004_SQ003.[i],data$matching2N3.SQ005_SQ003.[i],data$matching2N3.SQ006_SQ003.[i],data$matching2N3.SQ007_SQ003.[i],data$matching2N3.SQ008_SQ003.[i],data$matching2N3.SQ009_SQ003.[i],data$matching2N3.SQ010_SQ003.[i]))
  matching2L[[4]] <- rbind(
    cbind(data$matching2N4.SQ001_SQ001.[i],data$matching2N4.SQ002_SQ001.[i],data$matching2N4.SQ003_SQ001.[i],data$matching2N4.SQ004_SQ001.[i],data$matching2N4.SQ005_SQ001.[i],data$matching2N4.SQ006_SQ001.[i],data$matching2N4.SQ007_SQ001.[i],data$matching2N4.SQ008_SQ001.[i],data$matching2N4.SQ009_SQ001.[i],data$matching2N4.SQ010_SQ001.[i]),
    cbind(data$matching2N4.SQ001_SQ002.[i],data$matching2N4.SQ002_SQ002.[i],data$matching2N4.SQ003_SQ002.[i],data$matching2N4.SQ004_SQ002.[i],data$matching2N4.SQ005_SQ002.[i],data$matching2N4.SQ006_SQ002.[i],data$matching2N4.SQ007_SQ002.[i],data$matching2N4.SQ008_SQ002.[i],data$matching2N4.SQ009_SQ002.[i],data$matching2N4.SQ010_SQ002.[i]),
    cbind(data$matching2N4.SQ001_SQ003.[i],data$matching2N4.SQ002_SQ003.[i],data$matching2N4.SQ003_SQ003.[i],data$matching2N4.SQ004_SQ003.[i],data$matching2N4.SQ005_SQ003.[i],data$matching2N4.SQ006_SQ003.[i],data$matching2N4.SQ007_SQ003.[i],data$matching2N4.SQ008_SQ003.[i],data$matching2N4.SQ009_SQ003.[i],data$matching2N4.SQ010_SQ003.[i]),
    cbind(data$matching2N4.SQ001_SQ004.[i],data$matching2N4.SQ002_SQ004.[i],data$matching2N4.SQ003_SQ004.[i],data$matching2N4.SQ004_SQ004.[i],data$matching2N4.SQ005_SQ004.[i],data$matching2N4.SQ006_SQ004.[i],data$matching2N4.SQ007_SQ004.[i],data$matching2N4.SQ008_SQ004.[i],data$matching2N4.SQ009_SQ004.[i],data$matching2N4.SQ010_SQ004.[i]))
  matching2L[[5]] <- rbind(
    cbind(data$matching2N5.SQ001_SQ001.[i],data$matching2N5.SQ002_SQ001.[i],data$matching2N5.SQ003_SQ001.[i],data$matching2N5.SQ004_SQ001.[i],data$matching2N5.SQ005_SQ001.[i],data$matching2N5.SQ006_SQ001.[i],data$matching2N5.SQ007_SQ001.[i],data$matching2N5.SQ008_SQ001.[i],data$matching2N5.SQ009_SQ001.[i],data$matching2N5.SQ010_SQ001.[i]),
    cbind(data$matching2N5.SQ001_SQ002.[i],data$matching2N5.SQ002_SQ002.[i],data$matching2N5.SQ003_SQ002.[i],data$matching2N5.SQ004_SQ002.[i],data$matching2N5.SQ005_SQ002.[i],data$matching2N5.SQ006_SQ002.[i],data$matching2N5.SQ007_SQ002.[i],data$matching2N5.SQ008_SQ002.[i],data$matching2N5.SQ009_SQ002.[i],data$matching2N5.SQ010_SQ002.[i]),
    cbind(data$matching2N5.SQ001_SQ003.[i],data$matching2N5.SQ002_SQ003.[i],data$matching2N5.SQ003_SQ003.[i],data$matching2N5.SQ004_SQ003.[i],data$matching2N5.SQ005_SQ003.[i],data$matching2N5.SQ006_SQ003.[i],data$matching2N5.SQ007_SQ003.[i],data$matching2N5.SQ008_SQ003.[i],data$matching2N5.SQ009_SQ003.[i],data$matching2N5.SQ010_SQ003.[i]),
    cbind(data$matching2N5.SQ001_SQ004.[i],data$matching2N5.SQ002_SQ004.[i],data$matching2N5.SQ003_SQ004.[i],data$matching2N5.SQ004_SQ004.[i],data$matching2N5.SQ005_SQ004.[i],data$matching2N5.SQ006_SQ004.[i],data$matching2N5.SQ007_SQ004.[i],data$matching2N5.SQ008_SQ004.[i],data$matching2N5.SQ009_SQ004.[i],data$matching2N5.SQ010_SQ004.[i]),
    cbind(data$matching2N5.SQ001_SQ005.[i],data$matching2N5.SQ002_SQ005.[i],data$matching2N5.SQ003_SQ005.[i],data$matching2N5.SQ004_SQ005.[i],data$matching2N5.SQ005_SQ005.[i],data$matching2N5.SQ006_SQ005.[i],data$matching2N5.SQ007_SQ005.[i],data$matching2N5.SQ008_SQ005.[i],data$matching2N5.SQ009_SQ005.[i],data$matching2N5.SQ010_SQ005.[i]))
  matchingList2[[i]] <- matching2L
}

for (i in 1:length(matchingList2)) {    # for ego i
  mL <- matchingList2[[i]]              # get the matching list 2
  ns <- ns3[[i]]                        # get the size of egonet3
  if(ns>0) {                            # if ns=0, no matching was done!
    mm <- as.matrix(mL[[ns]])           # and the corresponding matrix
    matched <- which(mm==1, arr.ind=T)  # retrieve array indices
    net <- net3[i,]
    
    if(length(matched)>0) {             # if matching was performed!
      alterL[[i]]$name3[matched[,2]] <- net[matched[,1]]
    }
  }
}

#and for matching matrix 3 (i.e., matching egonet4 with egonets 1-3)
matchingList3 <- list()
for (i in 1:length(alterL)) { # for ego i
  matching3L <- list()
  matching3L[[1]] <- cbind(data$matching3N1.SQ001_SQ001.[i],data$matching3N1.SQ002_SQ001.[i],data$matching3N1.SQ003_SQ001.[i],data$matching3N1.SQ004_SQ001.[i],data$matching3N1.SQ005_SQ001.[i],data$matching3N1.SQ006_SQ001.[i],data$matching3N1.SQ007_SQ001.[i],data$matching3N1.SQ008_SQ001.[i],data$matching3N1.SQ009_SQ001.[i],data$matching3N1.SQ010_SQ001.[i], data$matching3N1.SQ011_SQ001.[i], data$matching3N1.SQ012_SQ001.[i], data$matching3N1.SQ013_SQ001.[i], data$matching3N1.SQ014_SQ001.[i], data$matching3N1.SQ015_SQ001.[i])
  matching3L[[2]] <- rbind(
    cbind(data$matching3N2.SQ001_SQ001.[i],data$matching3N2.SQ002_SQ001.[i],data$matching3N2.SQ003_SQ001.[i],data$matching3N2.SQ004_SQ001.[i],data$matching3N2.SQ005_SQ001.[i],data$matching3N2.SQ006_SQ001.[i],data$matching3N2.SQ007_SQ001.[i],data$matching3N2.SQ008_SQ001.[i],data$matching3N2.SQ009_SQ001.[i],data$matching3N2.SQ010_SQ001.[i], data$matching3N2.SQ011_SQ001.[i], data$matching3N2.SQ012_SQ001.[i], data$matching3N2.SQ013_SQ001.[i], data$matching3N2.SQ014_SQ001.[i], data$matching3N2.SQ015_SQ001.[i]),
    cbind(data$matching3N2.SQ001_SQ002.[i],data$matching3N2.SQ002_SQ002.[i],data$matching3N2.SQ003_SQ002.[i],data$matching3N2.SQ004_SQ002.[i],data$matching3N2.SQ005_SQ002.[i],data$matching3N2.SQ006_SQ002.[i],data$matching3N2.SQ007_SQ002.[i],data$matching3N2.SQ008_SQ002.[i],data$matching3N2.SQ009_SQ002.[i],data$matching3N2.SQ010_SQ002.[i], data$matching3N2.SQ011_SQ002.[i], data$matching3N2.SQ012_SQ002.[i], data$matching3N2.SQ013_SQ002.[i], data$matching3N2.SQ014_SQ002.[i], data$matching3N2.SQ015_SQ002.[i]))
  matching3L[[3]] <- rbind(
    cbind(data$matching3N3.SQ001_SQ001.[i],data$matching3N3.SQ002_SQ001.[i],data$matching3N3.SQ003_SQ001.[i],data$matching3N3.SQ004_SQ001.[i],data$matching3N3.SQ005_SQ001.[i],data$matching3N3.SQ006_SQ001.[i],data$matching3N3.SQ007_SQ001.[i],data$matching3N3.SQ008_SQ001.[i],data$matching3N3.SQ009_SQ001.[i],data$matching3N3.SQ010_SQ001.[i], data$matching3N3.SQ011_SQ001.[i], data$matching3N3.SQ012_SQ001.[i], data$matching3N3.SQ013_SQ001.[i], data$matching3N3.SQ014_SQ001.[i], data$matching3N3.SQ015_SQ001.[i]),
    cbind(data$matching3N3.SQ001_SQ002.[i],data$matching3N3.SQ002_SQ002.[i],data$matching3N3.SQ003_SQ002.[i],data$matching3N3.SQ004_SQ002.[i],data$matching3N3.SQ005_SQ002.[i],data$matching3N3.SQ006_SQ002.[i],data$matching3N3.SQ007_SQ002.[i],data$matching3N3.SQ008_SQ002.[i],data$matching3N3.SQ009_SQ002.[i],data$matching3N3.SQ010_SQ002.[i], data$matching3N3.SQ011_SQ002.[i], data$matching3N3.SQ012_SQ002.[i], data$matching3N3.SQ013_SQ002.[i], data$matching3N3.SQ014_SQ002.[i], data$matching3N3.SQ015_SQ002.[i]),
    cbind(data$matching3N3.SQ001_SQ003.[i],data$matching3N3.SQ002_SQ003.[i],data$matching3N3.SQ003_SQ003.[i],data$matching3N3.SQ004_SQ003.[i],data$matching3N3.SQ005_SQ003.[i],data$matching3N3.SQ006_SQ003.[i],data$matching3N3.SQ007_SQ003.[i],data$matching3N3.SQ008_SQ003.[i],data$matching3N3.SQ009_SQ003.[i],data$matching3N3.SQ010_SQ003.[i], data$matching3N3.SQ011_SQ003.[i], data$matching3N3.SQ012_SQ003.[i], data$matching3N3.SQ013_SQ003.[i], data$matching3N3.SQ014_SQ003.[i], data$matching3N3.SQ015_SQ003.[i]))
  matching3L[[4]] <- rbind(
    cbind(data$matching3N4.SQ001_SQ001.[i],data$matching3N4.SQ002_SQ001.[i],data$matching3N4.SQ003_SQ001.[i],data$matching3N4.SQ004_SQ001.[i],data$matching3N4.SQ005_SQ001.[i],data$matching3N4.SQ006_SQ001.[i],data$matching3N4.SQ007_SQ001.[i],data$matching3N4.SQ008_SQ001.[i],data$matching3N4.SQ009_SQ001.[i],data$matching3N4.SQ010_SQ001.[i], data$matching3N4.SQ011_SQ001.[i], data$matching3N4.SQ012_SQ001.[i], data$matching3N4.SQ013_SQ001.[i], data$matching3N4.SQ014_SQ001.[i], data$matching3N4.SQ015_SQ001.[i]),
    cbind(data$matching3N4.SQ001_SQ002.[i],data$matching3N4.SQ002_SQ002.[i],data$matching3N4.SQ003_SQ002.[i],data$matching3N4.SQ004_SQ002.[i],data$matching3N4.SQ005_SQ002.[i],data$matching3N4.SQ006_SQ002.[i],data$matching3N4.SQ007_SQ002.[i],data$matching3N4.SQ008_SQ002.[i],data$matching3N4.SQ009_SQ002.[i],data$matching3N4.SQ010_SQ002.[i], data$matching3N4.SQ011_SQ002.[i], data$matching3N4.SQ012_SQ002.[i], data$matching3N4.SQ013_SQ002.[i], data$matching3N4.SQ014_SQ002.[i], data$matching3N4.SQ015_SQ002.[i]),
    cbind(data$matching3N4.SQ001_SQ003.[i],data$matching3N4.SQ002_SQ003.[i],data$matching3N4.SQ003_SQ003.[i],data$matching3N4.SQ004_SQ003.[i],data$matching3N4.SQ005_SQ003.[i],data$matching3N4.SQ006_SQ003.[i],data$matching3N4.SQ007_SQ003.[i],data$matching3N4.SQ008_SQ003.[i],data$matching3N4.SQ009_SQ003.[i],data$matching3N4.SQ010_SQ003.[i], data$matching3N4.SQ011_SQ003.[i], data$matching3N4.SQ012_SQ003.[i], data$matching3N4.SQ013_SQ003.[i], data$matching3N4.SQ014_SQ003.[i], data$matching3N4.SQ015_SQ003.[i]),
    cbind(data$matching3N4.SQ001_SQ003.[i],data$matching3N4.SQ002_SQ003.[i],data$matching3N4.SQ003_SQ003.[i],data$matching3N4.SQ004_SQ003.[i],data$matching3N4.SQ005_SQ003.[i],data$matching3N4.SQ006_SQ003.[i],data$matching3N4.SQ007_SQ003.[i],data$matching3N4.SQ008_SQ003.[i],data$matching3N4.SQ009_SQ003.[i],data$matching3N4.SQ010_SQ003.[i], data$matching3N4.SQ011_SQ003.[i], data$matching3N4.SQ012_SQ003.[i], data$matching3N4.SQ013_SQ003.[i], data$matching3N4.SQ014_SQ003.[i], data$matching3N4.SQ015_SQ003.[i]),
    cbind(data$matching3N4.SQ001_SQ004.[i],data$matching3N4.SQ002_SQ004.[i],data$matching3N4.SQ003_SQ004.[i],data$matching3N4.SQ004_SQ004.[i],data$matching3N4.SQ005_SQ004.[i],data$matching3N4.SQ006_SQ004.[i],data$matching3N4.SQ007_SQ004.[i],data$matching3N4.SQ008_SQ004.[i],data$matching3N4.SQ009_SQ004.[i],data$matching3N4.SQ010_SQ004.[i], data$matching3N4.SQ011_SQ004.[i], data$matching3N4.SQ012_SQ004.[i], data$matching3N4.SQ013_SQ004.[i], data$matching3N4.SQ014_SQ004.[i], data$matching3N4.SQ015_SQ004.[i]))
  matching3L[[5]] <- rbind(
    cbind(data$matching3N5.SQ001_SQ001.[i],data$matching3N5.SQ002_SQ001.[i],data$matching3N5.SQ003_SQ001.[i],data$matching3N5.SQ004_SQ001.[i],data$matching3N5.SQ005_SQ001.[i],data$matching3N5.SQ006_SQ001.[i],data$matching3N5.SQ007_SQ001.[i],data$matching3N5.SQ008_SQ001.[i],data$matching3N5.SQ009_SQ001.[i],data$matching3N5.SQ010_SQ001.[i], data$matching3N5.SQ011_SQ001.[i], data$matching3N5.SQ012_SQ001.[i], data$matching3N5.SQ013_SQ001.[i], data$matching3N5.SQ014_SQ001.[i], data$matching3N5.SQ015_SQ001.[i]),
    cbind(data$matching3N5.SQ001_SQ002.[i],data$matching3N5.SQ002_SQ002.[i],data$matching3N5.SQ003_SQ002.[i],data$matching3N5.SQ004_SQ002.[i],data$matching3N5.SQ005_SQ002.[i],data$matching3N5.SQ006_SQ002.[i],data$matching3N5.SQ007_SQ002.[i],data$matching3N5.SQ008_SQ002.[i],data$matching3N5.SQ009_SQ002.[i],data$matching3N5.SQ010_SQ002.[i], data$matching3N5.SQ011_SQ002.[i], data$matching3N5.SQ012_SQ002.[i], data$matching3N5.SQ013_SQ002.[i], data$matching3N5.SQ014_SQ002.[i], data$matching3N5.SQ015_SQ002.[i]),
    cbind(data$matching3N5.SQ001_SQ003.[i],data$matching3N5.SQ002_SQ003.[i],data$matching3N5.SQ003_SQ003.[i],data$matching3N5.SQ004_SQ003.[i],data$matching3N5.SQ005_SQ003.[i],data$matching3N5.SQ006_SQ003.[i],data$matching3N5.SQ007_SQ003.[i],data$matching3N5.SQ008_SQ003.[i],data$matching3N5.SQ009_SQ003.[i],data$matching3N5.SQ010_SQ003.[i], data$matching3N5.SQ011_SQ003.[i], data$matching3N5.SQ012_SQ003.[i], data$matching3N5.SQ013_SQ003.[i], data$matching3N5.SQ014_SQ003.[i], data$matching3N5.SQ015_SQ003.[i]),
    cbind(data$matching3N5.SQ001_SQ003.[i],data$matching3N5.SQ002_SQ003.[i],data$matching3N5.SQ003_SQ003.[i],data$matching3N5.SQ004_SQ003.[i],data$matching3N5.SQ005_SQ003.[i],data$matching3N5.SQ006_SQ003.[i],data$matching3N5.SQ007_SQ003.[i],data$matching3N5.SQ008_SQ003.[i],data$matching3N5.SQ009_SQ003.[i],data$matching3N5.SQ010_SQ003.[i], data$matching3N5.SQ011_SQ003.[i], data$matching3N5.SQ012_SQ003.[i], data$matching3N5.SQ013_SQ003.[i], data$matching3N5.SQ014_SQ003.[i], data$matching3N5.SQ015_SQ003.[i]),
    cbind(data$matching3N5.SQ001_SQ005.[i],data$matching3N5.SQ002_SQ005.[i],data$matching3N5.SQ003_SQ005.[i],data$matching3N5.SQ004_SQ005.[i],data$matching3N5.SQ005_SQ005.[i],data$matching3N5.SQ006_SQ005.[i],data$matching3N5.SQ007_SQ005.[i],data$matching3N5.SQ008_SQ005.[i],data$matching3N5.SQ009_SQ005.[i],data$matching3N5.SQ010_SQ005.[i], data$matching3N5.SQ011_SQ005.[i], data$matching3N5.SQ012_SQ005.[i], data$matching3N5.SQ013_SQ005.[i], data$matching3N5.SQ014_SQ005.[i], data$matching3N5.SQ015_SQ005.[i]))
  matchingList3[[i]] <- matching3L
}

for (i in 1:length(matchingList3)) {    # for ego i
  mL <- matchingList3[[i]]              # get the matching list 2
  ns <- ns4[[i]]                        # get the size of egonet4
  if(ns>0) {                            # if ns=0, no matching was done!
    mm <- as.matrix(mL[[ns]])           # and the corresponding matrix
    matched <- which(mm==1, arr.ind=T)  # retrieve array indices
    net <- net4[i,]
    if(length(matched)>0) {             # if matching was performed!
      alterL[[i]]$name4[matched[,2]] <- net[matched[,1]]
    }
  }
}

# i use the name interpreter data to add (stable) alter characteristics (e.g., gender)
# in name-interpreter questions, only unique (i.e., non-matched) alters were listed... thus, alter ids without a gender assigned to them are non-uniques, and can later be filtered out.
df_gender <- data.frame(p1 = data$gender.SQ001.,p2 = data$gender.SQ002.,p3 = data$gender.SQ003.,p4 = data$gender.SQ004.,p5 = data$gender.SQ005.,p6 = data$gender.SQ006.,p7 = data$gender.SQ007.,p8 = data$gender.SQ008.,p9 = data$gender.SQ009.,p10= data$gender.SQ010.,p11= data$gender.SQ011.,p12= data$gender.SQ012.,p13= data$gender.SQ013.,p14= data$gender.SQ014.,p15= data$gender.SQ015.,p16= data$gender.SQ016.,p17= data$gender.SQ017.,p18= data$gender.SQ018.,p19= data$gender.SQ019.,p20= data$gender.SQ020.)

# same for age...
df_age <- data.frame(p1 = data$age.SQ001.,p2 = data$age.SQ002.,p3 = data$age.SQ003.,p4 = data$age.SQ004.,p5 = data$age.SQ005.,p6 = data$age.SQ006.,p7 = data$age.SQ007.,p8 = data$age.SQ008.,p9 = data$age.SQ009.,p10= data$age.SQ010.,p11= data$age.SQ011.,p12= data$age.SQ012.,p13= data$age.SQ013.,p14= data$age.SQ014.,p15= data$age.SQ015.,p16= data$age.SQ016.,p17= data$age.SQ017.,p18= data$age.SQ018.,p19= data$age.SQ019.,p20= data$age.SQ020.)

# kin
df_kin <- data.frame( p1 = data$kin.SQ001.,p2 = data$kin.SQ002.,p3 = data$kin.SQ003.,p4 = data$kin.SQ004.,p5 = data$kin.SQ005.,p6 = data$kin.SQ006.,p7 = data$kin.SQ007.,p8 = data$kin.SQ008.,p9 = data$kin.SQ009.,p10= data$kin.SQ010.,p11= data$kin.SQ011.,p12= data$kin.SQ012.,p13= data$kin.SQ013.,p14= data$kin.SQ014.,p15= data$kin.SQ015.,p16= data$kin.SQ016.,p17= data$kin.SQ017.,p18= data$kin.SQ018.,p19= data$kin.SQ019.,p20= data$kin.SQ020.)

#education
df_educ <- data.frame(p1 = data$educ.SQ001.,p2 = data$educ.SQ002.,p3 = data$educ.SQ003.,p4 = data$educ.SQ004.,p5 = data$educ.SQ005.,p6 = data$educ.SQ006.,p7 = data$educ.SQ007.,p8 = data$educ.SQ008., p9 = data$educ.SQ009.,p10= data$educ.SQ010., p11= data$educ.SQ011., p12= data$educ.SQ012., p13= data$educ.SQ013., p14= data$educ.SQ014., p15= data$educ.SQ015., p16= data$educ.SQ016., p17= data$educ.SQ017., p18= data$educ.SQ018., p19= data$educ.SQ019., p20= data$educ.SQ020.)

#also dynamic characteristics
#communication frequency
df_freq <- data.frame(p1 = data$freq.SQ001.,p2 = data$freq.SQ002.,p3 = data$freq.SQ003.,p4 = data$freq.SQ004.,p5 = data$freq.SQ005.,p6 = data$freq.SQ006.,p7 = data$freq.SQ007.,p8 = data$freq.SQ008., p9 = data$freq.SQ009.,p10= data$freq.SQ010., p11= data$freq.SQ011., p12= data$freq.SQ012., p13= data$freq.SQ013., p14= data$freq.SQ014., p15= data$freq.SQ015., p16= data$freq.SQ016., p17= data$freq.SQ017., p18= data$freq.SQ018., p19= data$freq.SQ019., p20= data$freq.SQ020.)

#closeness
df_close <- data.frame(p1 = data$close.SQ001.,p2 = data$close.SQ002.,p3 = data$close.SQ003.,p4 = data$close.SQ004.,p5 = data$close.SQ005.,p6 = data$close.SQ006.,p7 = data$close.SQ007.,p8 = data$close.SQ008., p9 = data$close.SQ009.,p10= data$close.SQ010., p11= data$close.SQ011., p12= data$close.SQ012., p13= data$close.SQ013., p14= data$close.SQ014., p15= data$close.SQ015., p16= data$close.SQ016., p17= data$close.SQ017., p18= data$close.SQ018., p19= data$close.SQ019., p20= data$close.SQ020.)

#and other dyadic featuers
# duration;
df_duration <- data.frame(p1 = data$duur.SQ001.,p2 = data$duur.SQ002.,p3 = data$duur.SQ003.,p4 = data$duur.SQ004.,p5 = data$duur.SQ005.,p6 = data$duur.SQ006.,p7 = data$duur.SQ007.,p8 = data$duur.SQ008., p9 = data$duur.SQ009.,p10= data$duur.SQ010., p11= data$duur.SQ011., p12= data$duur.SQ012., p13= data$duur.SQ013., p14= data$duur.SQ014., p15= data$duur.SQ015., p16= data$duur.SQ016., p17= data$duur.SQ017., p18= data$duur.SQ018., p19= data$duur.SQ019., p20= data$duur.SQ020.)

#geographical proximity
df_proximity <- data.frame(p1 = data$prox.SQ001.,p2 = data$prox.SQ002.,p3 = data$prox.SQ003.,p4 = data$prox.SQ004.,p5 = data$prox.SQ005.,p6 = data$prox.SQ006.,p7 = data$prox.SQ007.,p8 = data$prox.SQ008., p9 = data$prox.SQ009.,p10= data$prox.SQ010., p11= data$prox.SQ011., p12= data$prox.SQ012., p13= data$prox.SQ013., p14= data$prox.SQ014., p15= data$prox.SQ015., p16= data$prox.SQ016., p17= data$prox.SQ017., p18= data$prox.SQ018., p19= data$prox.SQ019., p20= data$prox.SQ020.)

for (i in 1:length(alterL)) {
  #gender
  alterL[[i]]$alter_gender <- 
    ifelse(unlist(df_gender[i,], use.names=F)=="Man", 0,  # male = ref.
           ifelse(unlist(df_gender[i,], use.names=F)=="Vrouw", 1,
                  ifelse(unlist(df_gender[i,], use.names=F)=="Anders", 2, "")))
  #kin  
  alterL[[i]]$kin <- 
    ifelse(unlist(df_kin[i,], use.names=F)=="Ja", 1,
           ifelse(unlist(df_kin[i,], use.names=F)=="Nee", 0, ""))
  #age  
  alterL[[i]]$alter_age <- 
    ifelse(unlist(df_age[i,], use.names=F)=="Jonger dan 18 jaar", 16, #???
           ifelse(unlist(df_age[i,], use.names=F)=="18 tot 21 jaar", 20,
                  ifelse(unlist(df_age[i,], use.names=F)=="22 tot 25 jaar", 23,
                         ifelse(unlist(df_age[i,], use.names=F)=="26 tot 30 jaar", 28,
                                ifelse(unlist(df_age[i,], use.names=F)=="31 tot 40 jaar", 35,
                                       ifelse(unlist(df_age[i,], use.names=F)=="Ouder dan 40 jaar", 45, #???
                                              ifelse(unlist(df_age[i,], use.names=F)=="Weet ik niet", NA, # i don't know = missing
                                                     unlist(df_age[i,], use.names=F))))))))
  #education
  alterL[[i]]$alter_educ <- ifelse(unlist(df_educ[i,],use.names=F)=="lagere school", 1,
                               ifelse(unlist(df_educ[i,],use.names=F)=="vmbo, mavo", 2,
                                      ifelse(unlist(df_educ[i,],use.names=F)=="mbo", 3,
                                         ifelse(unlist(df_educ[i,],use.names=F)=="havo", 4,
                                            ifelse(unlist(df_educ[i,],use.names=F)=="vwo / gymnasium", 5,
                                                 ifelse(unlist(df_educ[i,],use.names=F)=="hbo", 6,
                                                     ifelse(unlist(df_educ[i,],use.names=F)=="universiteit", 7, NA))))))) 
  #frequency
  alterL[[i]]$frequency.t1 <- ifelse(unlist(df_freq[i,],use.names=F)=="(Bijna) elke dag", 7,
                               ifelse(unlist(df_freq[i,],use.names=F)=="1-2 keer per week",6,
                                      ifelse(unlist(df_freq[i,],use.names=F)=="Aantal keer per maand",5, 
                                         ifelse(unlist(df_freq[i,],use.names=F)=="Ong. 1 keer per maand",4, 
                                            ifelse(unlist(df_freq[i,],use.names=F)=="Aantal keer per jaar",3,
                                                 ifelse(unlist(df_freq[i,],use.names=F)=="Ong. 1 keer per jaar",2,
                                                     ifelse(unlist(df_freq[i,],use.names=F)=="Nooit",1, NA )))))))
  #closeness
  alterL[[i]]$closeness.t1 <- ifelse(unlist(df_close[i,],use.names=F)=="Niet hecht", 1, 
                               ifelse(unlist(df_close[i,],use.names=F)=="Enigszins hecht", 2,
                                      ifelse(unlist(df_close[i,],use.names=F)=="Hecht", 3,
                                             ifelse(unlist(df_close[i,],use.names=F)=="Heel erg hecht", 4, NA ))))
  #proximity
  alterL[[i]]$proximity <- ifelse(unlist(df_proximity[i,], use.names=FALSE) == "In hetzelfde huis", "roommate",
                                  ifelse(unlist(df_proximity[i,], use.names = FALSE) == "In dezelfde buurt" |
                                    unlist(df_proximity[i,],use.names=F)=="In dezelfde straat" |
                                    unlist(df_proximity[i,],use.names=F)=="In dezelfde gemeente", "close",
                                    ifelse(unlist(df_proximity[i,], use.names = FALSE) == "In hetzelfde land" |
                                             unlist(df_proximity[i,], use.names = FALSE) == "In een ander land","far", NA)))

  
   #duration:  take midpoint on scale.
   alterL[[i]]$duration <- ifelse(unlist(df_duration[i,],use.names=F)=="Minder dan 1 jaar", 0, 
                               ifelse(unlist(df_duration[i,],use.names=F)=="1 tot 3 jaar", 2,
                                      ifelse(unlist(df_duration[i,],use.names=F)=="4 tot 8 jaar", 6,
                                             ifelse(unlist(df_duration[i,],use.names=F)=="9 tot 15 jaar", 12,
                                                    ifelse(unlist(df_duration[i,],use.names=F)=="Meer dan 15 jaar", 15,NA )))))
}

#for sports partners, how frequent they participate and how competent they are in the sport they do with ego.
df_altfreq <- data.frame(p1 = data$altfreq1, p2 = data$altfreq2, p3 = data$altfreq3, p4 = data$altfreq4, p5 = data$altfreq5)
df_altgrade <- data.frame(p1 = data$grade1, p2 = data$grade2, p3 = data$grade3, p4 = data$grade4, p5 = data$grade5)

for (i in 1:length(alterL)) { 
  alterL[[i]]$alter_freq[16:20] <- unlist(df_altfreq[i,], use.names=TRUE)
  alterL[[i]]$alter_grade[16:20] <- unlist(df_altgrade[i,], use.names=TRUE)
}

# before we can construct similarity indices, we must add ego-attributes
for (i in 1:length(alterL)) {
  #  gender
  alterL[[i]]$ego_gender <- ifelse(data$A1[i] == "Man", 0,ifelse(data$A1[i] == "Vrouw", 1,ifelse(data$A1[i] == "Overige", 2,NA)))
  
  # education 
  # these score should correspond to scores given to alter educ...
  alterL[[i]]$ego_educ <- ifelse(data$T1[i] == "aan de Hogeschool van Arnhem en Nijmegen (HAN)", "6", "7" )
 
  # age
  # calculated as the difference between submission date and birthdate
  # in years.
  birth_date <- as.Date(data$A2[i])
  #x_date <- as.Date(data$submitdate) #submission date was not deposited; so, take 1-jan 2023
  x_date <- as.Date("2023-01-01")
  alterL[[i]]$ego_age <- trunc((birth_date %--% x_date) / years(1))
}

# i also want to know ego's sports frequency and skill
# ultimately, i want to make a dyadic variable indicating the skill level (difference) of ego and alter, in *the specific sports that they do together*
# for now, i will put ego's sports frequency and skill, per sport, in a dataframe. 
# also, the setting ego participates each sports in (e.g., alone, informal, club-organized, ...)

#frequency
egos <- data %>%
  select(S3X.SQ001.:S3X.SQ017., S3bX.SQ001.:S3bX.SQ017. )
egos[egos == "Minder dan 1 keer per maand"] <- 0.125
egos[egos == "1 keer per maand" ] <- 0.25
egos[egos == "2 keer per maand" ] <- 0.5
egos[egos == "1 keer per week" ] <- 1

#in cases where ego participated more than once a week, get the answer to the questino how often per week he/she participated
for (i in 1:17) {
  egos[,i] <- ifelse(egos[,i] == "Vaker dan 1 keer per week", gsub("\\D", "", egos[,17+i]), egos[,i])
}
egos[,1:17] -> egos
egos <- mutate_all(egos, as.numeric)

#and skill
egos2 <- data %>%
  select(S2b.SQ001.: S2b.SQ017.)

#and setting
egos3 <- data %>%
  select(S2a.SQ001. : S2a.SQ017.)
egos3[egos3 == "Als lid van een commerciÃ«le sportaanbieder (bijv., fitnesscentrum)"] <- "gym"
egos3[egos3 == "Als lid van een sportvereniging"] <- "club"
egos3[egos3 == "In groepsverband, georganiseerd door jezelf, familie, vrienden, en/of kennissen"] <- "informal"
egos3[egos3 == "Alleen, ongeorganiseerd"] <- "alone"

#let's add ego's fitness traits to the dfs:
for (i in 1:length(alterL)) {
  alterL[[i]]$ego_fitness_freq <- egos$S3X.SQ001.[i]
  alterL[[i]]$ego_fitness_skill <- egos2$S2b.SQ001.[i]
  alterL[[i]]$ego_fitness_setting <- egos3$S2a.SQ001.[i]
}

# get for each sports partner in the list of alters, the sports ego does with them
for (i in 1:length(alterL)) { # for ego

  alterL[[i]]$sporttogether[16:20] <-
    
    c( ifelse( length(which( data[i,] %>%
  select(samenCSN1.SQ001.:samenCSN1.SQ017.) == "Ja" )) > 0,
  which(data[i,] %>% select(samenCSN1.SQ001.:samenCSN1.SQ017.) == "Ja" ), NA),
  
  ifelse( length(which( data[i,] %>%
  select(samenCSN2.SQ001.:samenCSN2.SQ017.) == "Ja" )) > 0,
  which(data[i,] %>% select(samenCSN2.SQ001.:samenCSN2.SQ017.) == "Ja" ), NA),
  
  ifelse( length(which( data[i,] %>%
  select(samenCSN3.SQ001.:samenCSN3.SQ017.) == "Ja" )) > 0,
  which(data[i,] %>% select(samenCSN3.SQ001.:samenCSN3.SQ017.) == "Ja" ), NA),
  
  ifelse( length(which( data[i,] %>%
  select(samenCSN4.SQ001.:samenCSN4.SQ017.) == "Ja" )) > 0,
  which(data[i,] %>% select(samenCSN4.SQ001.:samenCSN4.SQ017.) == "Ja" ), NA),
  
  ifelse( length(which( data[i,] %>%
  select(samenCSN5.SQ001.:samenCSN5.SQ017.) == "Ja" )) > 0,
  which(data[i,] %>% select(samenCSN5.SQ001.:samenCSN5.SQ017.) == "Ja" ), NA)
  )
}

# i filter out the unique, non-duplicate alters;
# by excluding alters with empty strings for gender attribute

#but first, match sports attributes.
#that is, from sports partners (p16-p20) to other alters who correspond to sports partners (name4)
for (i in 1:length(alterL)) {
  for (j in which(!is.na(alterL[[i]]$name4))) {
    alterL[[i]][j, c("alter_freq", "alter_grade", "sporttogether")] <- alterL[[i]][which(alterL[[i]]$name1 == alterL[[i]]$name4[j]), c("alter_freq", "alter_grade", "sporttogether")]
  }
}

#now do the filtering on gender, to filter out duplicates.
for ( i in 1:length(alterL)) {
  
  alterL[[i]] <- alterL[[i]][which(alterL[[i]]$alter_gender!=""),]
  # and replace the alter id: 1 : no. unique alters
  if(nrow(alterL[[i]]) > 0 ){ #only for respondents who named at least 1 alter.
  alterL[[i]]$alterid <- 1:nrow(alterL[[i]])}
}

#attach ego_grade, ego's self-assessed skill for the sports he/she does together with alter
#and ego_freq, ego's sports frequency in this sports activity
#and ego_context, the social sporting context in which ego does this activity (assumedly, with alter)
for (i in 1:length(alterL)) { #for ego i
  
    if(nrow(alterL[[i]]) > 0) {
      
      alterL[[i]]$ego_grade <- NA
      alterL[[i]]$ego_freq <- NA
      alterL[[i]]$ego_context <- NA
      
      for (j in which(!is.na(alterL[[i]]$sporttogether))) { #for alters with a value on the 'sporttogether' attribute (i.e., who belong to sportnetwork)
        
        #attach ego's self-assessed sports skill for the sports he/she did with alter with alterid j
        alterL[[i]]$ego_grade[alterL[[i]]$alterid == j] <- egos2[i, alterL[[i]]$sporttogether[j]]
    
        #and ego's self-assessed sports frequency for this sports type
        alterL[[i]]$ego_freq[alterL[[i]]$alterid == j] <- egos[i, alterL[[i]]$sporttogether[j]]
        
        #and the setting in which ego engaged (with alter) in this sports type
        alterL[[i]]$ego_context[alterL[[i]]$alterid == j] <- egos3[i, alterL[[i]]$sporttogether[j]]
  }
  }
}

#dyadic similarity measures
for (i in 1:length(alterL))  { # for ego i
  
    if(nrow(alterL[[i]]) > 0) {
      
      # get attributes of ego
      agei <- alterL[[i]]$ego_age[1]
      genderi <- alterL[[i]]$ego_gender[1]
      edi <- alterL[[i]]$ego_educ[1]
      
      for (j in 1:max(alterL[[i]]$alterid)) { # for alter j
        # calculate "same gender" (0/1)
        genderj <- as.numeric(alterL[[i]]$alter_gender[j]) # get alter j gender
        same <- ifelse(genderi==genderj, 1, 0)
        alterL[[i]]$same_gender[which(alterL[[i]]$alterid==j)] <- same
        
        #same education
        eduj <- alterL[[i]]$alter_educ[j]
        same <- ifelse(eduj==edi, 1, 0)
        alterL[[i]]$sim_educ[which(alterL[[i]]$alterid==j)] <- same
        
        # calculate similarity for age as the absolute difference between alter and ego value
        #get alter j attributes
        agej <- as.numeric(alterL[[i]]$alter_age[j])
        #difference score
        difage <- abs(agei - agej)
        
        # so higher values represent *less* similarity
        if( !is.na (agej) ) { # age similarity only calculable if z_j is known!
            alterL[[i]]$dif_age[which(alterL[[i]]$alterid==j)] <- difage
          } else { alterL[[i]]$dif_age[which(alterL[[i]]$alterid==j)] <- NA}
      }
    }
}

#based on this, i make a long dataframe with alters nested in ego.
#first, add an ego_id
for (i in 1:length(alterL)) {
  if(nrow(alterL[[i]]) > 0) {
      alterL[[i]]$ego <- i
      alterL[[i]]$respnr <- data$respnr[i]
      }
  }

#combine using rbind
df <- do.call(rbind,alterL)

#binary attributes indicating whether alters appeared in each of the ego-nets at w1.
for (i in unique(df$ego)) {   
    for (j in 1:nrow(df[which(df$ego==i),])) { # for alters nested in ego

    # find out if alter_id denoting alter j appear in the 4 egonets
    alter <- unlist(df[which(df$ego==i & df$alterid==j),][5:8], use.names = FALSE) # get name(s) of alter j
    alter <- alter[!is.na(alter)] # exclude NAs
  
    cdn <- alter %in% net1[i,]
    study <- alter %in% net2[i,]
    bff <- alter %in% net3[i,]
    csn <- alter %in% net4[i,]
    
    # and if so, give alter j score 1 on indicators; 0 otherwise
    df$cdn1[which(df$ego==i & df$alterid==j)] <- ifelse("TRUE" %in% cdn, 1, 0)
    df$study1[which(df$ego==i & df$alterid==j)] <- ifelse("TRUE" %in% study, 1, 0)
    df$bff1[which(df$ego==i & df$alterid==j)] <- ifelse("TRUE" %in% bff, 1, 0)
    df$csn1[which(df$ego==i & df$alterid==j)] <- ifelse("TRUE" %in% csn, 1, 0)
  }
}
``` 

<br>

## Network properties 

make new dataframe to store network information in; aggregate network info to egos.

```{r, netdat, eval=FALSE}
netdat <- data.frame(respnr = unique(df$respnr),
                     nfitp = NA,
                     propFriend = NA,
                     avFreq = NA
                     )

#i am going to calculate average freq of fitness partners; so first convert variables to numeric
df$alter_freq_numeric <-  ifelse(df$alter_freq == "1 of 2 keer per maand", 1.5 * 12,
                   ifelse(df$alter_freq == "1 keer per week", 1 * 52,
                   ifelse(df$alter_freq == "2 of 3 keer per week", 2.5 * 52,
                   ifelse(df$alter_freq == "4 of 5 keer per week", 4.5 * 52,
                   ifelse(df$alter_freq == "Minder dan 1 keer per maand", 0.5 * 12,
                   ifelse(df$alter_freq == "6 keer per week of vaker", 6 * 52, NA))))))


for (i in unique(netdat$respnr)) {
  
  #get indicators of fitness partner(s):
  ind <- which(df[df$respnr == i,]$sporttogether == 1)
  
  #fitness network size (no. of fitness partners):
  netdat$nfitp[netdat$respnr == i] <- length(ind)
  
  #fitness network composition:
  #% of fitness partners identified as best friend;
  netdat$propFriend[netdat$respnr == i] <- ifelse(length(ind) > 0, length(which(df[df$respnr == i, ][ind,]$bff1 == 1)) / length(ind), 0)
  
  #average frequency of fitness participation of fitness partners
  netdat$avFreq[netdat$respnr == i] <- ifelse(length(ind) > 0, mean(df[df$respnr == i,][ind,]$alter_freq_numeric, na.rm = TRUE), 0)
}

table(netdat$nfitp) #one person with more than 5 fitness partners, which is impossible (but is due to incorrent matching by the respondent... remove this person from our netdat dataframe)
netdat[-which(netdat$nfitp>5),] -> netdat

#also store some relevant ego info that may be relevant for the outcome (sports behavior)

for (i in unique(netdat$respnr)) {
  netdat$education[netdat$respnr == i] <- df$ego_educ[df$respnr == i][1]
  netdat$age[netdat$respnr == i] <- df$ego_age[df$respnr == i][1]
  netdat$female[netdat$respnr == i] <- df$ego_gender[df$respnr == i][1]
  netdat$ego_fitness[netdat$respnr == i] <- df$ego_fitness_freq[df$respnr == i][1]
  
}

#descriptives


psych::describe(netdat[complete.cases(netdat),-1])
```

<br>

----

# Behavioral data

Data collected about sports activities of respondents, by the university sports center.

```{r, behdat, eval = FALSE}
#load activity data.
#NOTE these are not public
act <- read.csv("./rawdata/aoactiviteiten.csv", sep = ";")
nrow(act) #131331 sports activities!

#load sleutelbestand/kefile containing respnr-email combinations, which i need to merge the network data and the behavior data
key <- fload("./rawdata/sleutelbestand_respnr_email.Rda")

#add respnr to activity data
act <- merge(act, key, by = "email")

#subset all activities from the onset of the academic year 2022-2023
act2 <- act[act$datum > "2022-09-04", ]

#remove sensitive info
act2 <- act2[,-c(1:5,7,13,17)]
#head(act)

#make a dataframe to story activity data in; for now just number of fitness sessions; and all other sports activities.
behdat <- data.frame(respnr = data$respnr,
                      nfitness = NA,
                      nother = NA
                      )

for (i in unique(behdat$respnr)) {
  #get activity data of i
  egact <- act2[act2$respnr == i,]
  
  #store info in our dataset
  behdat$nfitness[behdat$respnr == i] <- length(which(egact$naam == "Fitness"))
  behdat$nother[behdat$respnr == i] <- length(which(!egact$naam == "Fitness"))
}

#lastly, combine datasets
netbehdat <- merge(netdat,behdat, by = "respnr")

#and save
fsave(netbehdat, "netbehdata.RDa")
```

---

# References
